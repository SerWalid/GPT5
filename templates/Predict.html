{% extends "base.html" %}

{% block title %}DisasterSense - AI Disaster Prediction{% endblock %}

{% block extra_head %}
<!-- Add Leaflet CSS for map selection -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
{% endblock %}

{% block hero %}
<section class="bg-gradient-to-r from-primary to-purple-800 text-white py-16">
    <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">DisasterSense</h1>
        <p class="text-xl text-white text-opacity-90 max-w-3xl mx-auto">Advanced AI-powered prediction of floods, earthquakes, wildfires, hurricanes, and other natural disasters.</p>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="py-12">
    <div class="container mx-auto px-4">
        <div class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 text-center">Predict Natural Disasters</h2>
            <p class="mt-4 text-gray-600 max-w-3xl mx-auto text-center">Our advanced AI analyzes historical data, weather patterns, seismic activity, and geographical factors to predict potential disasters.</p>
        </div>
        
        <!-- Prediction Tool Section -->
        <div class="bg-white rounded-xl shadow-md border border-gray-100 p-6 mb-12 max-w-5xl mx-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Disaster Risk Assessment</h3>
            
            <form id="prediction-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <div class="flex">
                            <input type="text" id="location" name="location" placeholder="Enter address, city, or region" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-l-md focus:ring-primary focus:border-primary">
                            <button type="button" id="search-location" class="bg-primary text-white px-4 py-2 rounded-r-md hover:bg-purple-700">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Or click on the map to select a location</p>
                        
                        <!-- Hidden fields for coordinates -->
                        <input type="hidden" id="lat" name="lat">
                        <input type="hidden" id="lng" name="lng">
                    </div>
                    
                    <div class="md:col-span-2">
                        <div id="location-map" class="w-full h-64 rounded-lg border border-gray-200 bg-gray-100"></div>
                        <div id="selected-location" class="text-sm font-medium text-gray-700 mt-2 hidden"></div>
                    </div>
                    
                    <div>
                        <label for="disaster-type" class="block text-sm font-medium text-gray-700 mb-1">Disaster Type</label>
                        <select id="disaster-type" name="disaster-type" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                            <option value="all">All Types</option>
                            <option value="flood">Flood</option>
                            <option value="earthquake">Earthquake</option>
                            <option value="wildfire">Wildfire</option>
                            <option value="hurricane">Hurricane</option>
                            <option value="tornado">Tornado</option>
                            <option value="drought">Drought</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="time-range" class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                        <select id="time-range" name="time-range" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                            <option value="7">Next 7 days</option>
                            <option value="30" selected>Next 30 days</option>
                            <option value="90">Next 3 months</option>
                            <option value="180">Next 6 months</option>
                            <option value="365">Next year</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="analysis-depth" class="block text-sm font-medium text-gray-700 mb-1">Analysis Depth</label>
                        <select id="analysis-depth" name="analysis-depth" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                            <option value="standard">Standard (Fast)</option>
                            <option value="advanced">Advanced (Recommended)</option>
                            <option value="comprehensive">Comprehensive (Thorough)</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button type="button" id="predict-btn" class="w-full px-6 py-3 bg-primary text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-200 shadow-md">
                            Generate Prediction
                        </button>
                    </div>
                </div>
            </form>
            
            <div id="prediction-loading" class="hidden mt-8">
                <div class="flex flex-col items-center justify-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent mb-4"></div>
                    <p class="text-gray-600 font-medium">Processing data and generating prediction...</p>
                    <div class="w-full max-w-md bg-gray-200 rounded-full h-2.5 mt-4">
                        <div id="prediction-progress" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="prediction-status" class="text-sm text-gray-500 mt-2">Analyzing location data...</p>
                </div>
            </div>
            
            <div id="prediction-results" class="hidden mt-8 border-t border-gray-200 pt-6">
                <!-- Results will be populated here by JavaScript -->
            </div>
        </div>
        
        <!-- How It Works Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="h-12 w-12 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-database text-primary"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Data Collection</h3>
                <p class="text-gray-600">Our AI continuously analyzes historical disaster data, satellite imagery, weather patterns, and geographical information.</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="h-12 w-12 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-brain text-primary"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">AI Processing</h3>
                <p class="text-gray-600">Advanced machine learning models identify patterns and risk factors specific to each disaster type and geographical location.</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <div class="h-12 w-12 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-chart-line text-primary"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Risk Assessment</h3>
                <p class="text-gray-600">DisasterSense delivers actionable predictions with risk levels, probability scores, and recommended safety measures.</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the map
        const map = L.map('location-map').setView([34.0522, -118.2437], 3); // Default view of world map
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        let marker = null;
        
        // Add click listener to the map
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Update hidden inputs
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
            
            // Update or create marker
            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }
            
            // Get location name using reverse geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`)
                .then(response => response.json())
                .then(data => {
                    const locationName = data.display_name;
                    document.getElementById('location').value = locationName;
                    document.getElementById('selected-location').textContent = `Selected: ${locationName}`;
                    document.getElementById('selected-location').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error getting location name:', error);
                    document.getElementById('selected-location').textContent = `Selected: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    document.getElementById('selected-location').classList.remove('hidden');
                });
        });
        
        // Search location button handler
        document.getElementById('search-location').addEventListener('click', function() {
            const locationInput = document.getElementById('location').value;
            if (!locationInput) return;
            
            fetch(`/api/geocode?location=${encodeURIComponent(locationInput)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Location not found. Please try a different search term.');
                        return;
                    }
                    
                    const lat = data.lat;
                    const lng = data.lng;
                    
                    // Update hidden inputs
                    document.getElementById('lat').value = lat;
                    document.getElementById('lng').value = lng;
                    
                    // Update or create marker and center map
                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map);
                    }
                    
                    map.setView([lat, lng], 10);
                    
                    // Update display name
                    document.getElementById('selected-location').textContent = `Selected: ${data.display_name}`;
                    document.getElementById('selected-location').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error searching location:', error);
                    alert('An error occurred while searching for this location.');
                });
        });
        
        // Also trigger search on Enter key
        document.getElementById('location').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('search-location').click();
            }
        });
        
        // Predict button handler
        document.getElementById('predict-btn').addEventListener('click', function() {
            const location = document.getElementById('location').value;
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const disasterType = document.getElementById('disaster-type').value;
            const timeRange = document.getElementById('time-range').value;
            const analysisDepth = document.getElementById('analysis-depth').value;
            
            if (!location || !lat || !lng) {
                alert('Please select a location on the map or search for one.');
                return;
            }
            
            // Show loading state
            const loading = document.getElementById('prediction-loading');
            const results = document.getElementById('prediction-results');
            const progress = document.getElementById('prediction-progress');
            const status = document.getElementById('prediction-status');
            
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            
            // Simulate progress (will be replaced by actual API call)
            let progressValue = 0;
            const progressInterval = setInterval(() => {
                progressValue += analysisDepth === 'comprehensive' ? 1 : (analysisDepth === 'advanced' ? 2 : 4);
                progress.style.width = `${Math.min(progressValue, 95)}%`;
                
                // Update status messages based on progress
                if (progressValue < 20) {
                    status.textContent = "Analyzing historical disaster data...";
                } else if (progressValue < 40) {
                    status.textContent = "Evaluating geographical risk factors...";
                } else if (progressValue < 60) {
                    status.textContent = "Consulting AI prediction models...";
                } else if (progressValue < 80) {
                    status.textContent = "Generating risk assessment...";
                } else {
                    status.textContent = "Finalizing prediction report...";
                }
                
                if (progressValue >= 100) {
                    clearInterval(progressInterval);
                }
            }, 100);
            
            // Make the actual API call
            fetch('/api/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    location: location,
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    disasterType: disasterType,
                    timeRange: timeRange,
                    analysisDepth: analysisDepth
                })
            })
            .then(response => response.json())
            .then(data => {
                // Clear the interval when we get real data
                clearInterval(progressInterval);
                progress.style.width = '100%';
                
                setTimeout(() => {
                    // Display results
                    displayResults(data);
                    loading.classList.add('hidden');
                    results.classList.remove('hidden');
                }, 500);
            })
            .catch(error => {
                console.error('Error making prediction:', error);
                clearInterval(progressInterval);
                progress.style.width = '100%';
                
                alert('An error occurred while generating the prediction. Please try again.');
                loading.classList.add('hidden');
            });
        });
        
        // Function to display results
        function displayResults(data) {
            const resultsContainer = document.getElementById('prediction-results');
            
            // Format the prediction date range
            const predictionDateFrom = new Date(data.prediction_parameters.prediction_date);
            const predictionDateTo = new Date(data.prediction_parameters.prediction_end_date);
            const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
            const dateRangeText = `${predictionDateFrom.toLocaleDateString(undefined, dateOptions)} to ${predictionDateTo.toLocaleDateString(undefined, dateOptions)}`;
            
            // Start building the HTML for results
            let resultsHTML = `
                <h3 class="text-xl font-bold text-gray-800 mb-2">Prediction Results for ${data.location.name}</h3>
                <p class="text-gray-600 mb-6">Prediction period: ${dateRangeText}</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            `;
            
            // Add risk cards for each disaster type
            const riskColors = {
                high: {bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-500', indicator: 'bg-red-500'},
                medium: {bg: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-500', indicator: 'bg-amber-500'},
                low: {bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-600', indicator: 'bg-green-600'}
            };
            
            const disasterIcons = {
                flood: 'fa-water',
                wildfire: 'fa-fire',
                earthquake: 'fa-mountain',
                hurricane: 'fa-wind',
                tornado: 'fa-tornado',
                drought: 'fa-sun',
            };
            
            // Sort disaster types by probability (highest first)
            const disasterTypes = Object.keys(data.risk_assessment).sort((a, b) => {
                return data.risk_assessment[b].probability - data.risk_assessment[a].probability;
            });
            
            for (const disasterType of disasterTypes) {
                const risk = data.risk_assessment[disasterType];
                const colors = riskColors[risk.level] || riskColors.low;
                const icon = disasterIcons[disasterType] || 'fa-exclamation-triangle';
                
                resultsHTML += `
                    <div class="${colors.bg} border ${colors.border} rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div class="${colors.text} mr-2"><i class="fas ${icon}"></i></div>
                                <h4 class="font-bold">${disasterType.charAt(0).toUpperCase() + disasterType.slice(1)} Risk</h4>
                            </div>
                            <div class="text-sm font-bold px-2 py-1 ${colors.indicator} text-white rounded-full">
                                ${risk.level.charAt(0).toUpperCase() + risk.level.slice(1)}
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${colors.indicator} h-2 rounded-full" style="width: ${risk.probability}%"></div>
                            </div>
                            <div class="flex justify-between text-xs mt-1">
                                <span>Low Risk</span>
                                <span>High Risk</span>
                            </div>
                        </div>
                `;
                
                // Add key factors if available
                if (risk.key_factors) {
                    resultsHTML += `
                        <div class="mt-3 text-sm">
                            <span class="font-medium">Key factors:</span>
                            <ul class="list-disc pl-5 text-gray-600 mt-1">
                                ${risk.key_factors.map(factor => `<li>${factor}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Add onset timeframe if available
                if (risk.onset_timeframe) {
                    resultsHTML += `
                        <div class="mt-2 text-sm">
                            <span class="font-medium">Potential onset:</span>
                            <span class="text-gray-600"> ${risk.onset_timeframe}</span>
                        </div>
                    `;
                }
                
                resultsHTML += `</div>`;
            }
            
            // Close the grid
            resultsHTML += `</div>`;
            
            // Add analysis summary if available
            if (data.analysis_summary) {
                resultsHTML += `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                        <h4 class="font-bold text-gray-800 mb-2">Analysis Summary</h4>
                        <p class="text-gray-600">${data.analysis_summary}</p>
                    </div>
                `;
            }
            
            // Add recommendations
            if (data.recommendations && data.recommendations.length > 0) {
                resultsHTML += `
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-bold text-gray-800 mb-2">Recommendations</h4>
                        <ul class="list-disc pl-5 text-gray-600 space-y-1">
                            ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Add action buttons
            resultsHTML += `
                <div class="mt-6 flex flex-wrap justify-between items-center">
                    
                    <div class="space-x-2">
                        <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition">
                            <i class="fas fa-bell mr-1"></i> Set Alerts
                        </button>
                        <button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-purple-700 transition">
                            <i class="fas fa-shield-alt mr-1"></i> Safety Plan
                        </button>
                    </div>
                </div>
            `;
            
            // Update the results container
            resultsContainer.innerHTML = resultsHTML;
        }
    });
</script>
{% endblock %}


